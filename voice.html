<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronunciation Matching</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        audio {
            margin-top: 20px;
        }
        #result {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <h1>Pronunciation Matching</h1>

    <p>Listen to the word:</p>
    <audio id="preloadedAudio" controls>
        <source src="fingers.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <p>Record your pronunciation:</p>
    <button id="recordButton">Start Recording</button>
    <button id="stopButton" disabled>Stop Recording</button>

    <audio id="userAudio" controls></audio>

    <button id="compareButton" disabled>Compare Pronunciation</button>
    
    <div id="result"></div>

    <script>
        let mediaRecorder;
        let recordedBlobs;
        let audioContext;
        let analyser;
        let frequencyData;

        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const compareButton = document.getElementById('compareButton');
        const userAudio = document.getElementById('userAudio');
        const resultDiv = document.getElementById('result');
        const preloadedAudio = document.getElementById('preloadedAudio');

        recordButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);
        compareButton.addEventListener('click', compareAudio);

        function startRecording() {
            recordedBlobs = [];
            const constraints = { audio: true };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = handleDataAvailable;
                    mediaRecorder.start();
                    recordButton.disabled = true;
                    stopButton.disabled = false;
                })
                .catch(error => {
                    console.error('Error accessing media devices.', error);
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            stopButton.disabled = true;
            recordButton.disabled = false;
            compareButton.disabled = false;
        }

        function handleDataAvailable(event) {
            if (event.data && event.data.size > 0) {
                recordedBlobs.push(event.data);
            }
            const superBuffer = new Blob(recordedBlobs, { type: 'audio/webm' });
            userAudio.src = window.URL.createObjectURL(superBuffer);
        }

        async function compareAudio() {
            try {
                if (!userAudio.src) {
                    resultDiv.textContent = "Please record your pronunciation first.";
                    return;
                }

                const preloadedBuffer = await loadAudioBuffer(preloadedAudio.querySelector('source').src);
                const recordedBuffer = await loadAudioBuffer(userAudio.src);

                const preloadedFreqData = await getFrequencyData(preloadedBuffer);
                const recordedFreqData = await getFrequencyData(recordedBuffer);

                const similarity = calculateCrossCorrelation(preloadedFreqData, recordedFreqData);

                if (similarity > 0.8) {
                    resultDiv.textContent = 'The pronunciations are similar!';
                } else {
                    resultDiv.textContent = 'The pronunciations are different.';
                }
            } catch (error) {
                console.error('Error during comparison:', error);
                resultDiv.textContent = 'An error occurred during comparison. Please try again.';
            }
        }

        function loadAudioBuffer(url) {
            return fetch(url)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    return audioContext.decodeAudioData(arrayBuffer);
                })
                .catch(error => {
                    console.error('Error loading audio buffer:', error);
                    resultDiv.textContent = 'Failed to load audio.';
                });
        }

        function getFrequencyData(audioBuffer) {
            return new Promise((resolve) => {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                frequencyData = new Float32Array(analyser.frequencyBinCount);

                const offlineCtx = new OfflineAudioContext(1, audioBuffer.length, audioBuffer.sampleRate);
                const offlineSource = offlineCtx.createBufferSource();
                offlineSource.buffer = audioBuffer;
                offlineSource.connect(analyser);
                analyser.connect(offlineCtx.destination);
                offlineSource.start(0);
                offlineCtx.startRendering().then(() => {
                    analyser.getFloatFrequencyData(frequencyData);
                    resolve(frequencyData);
                });
            });
        }

        function calculateCrossCorrelation(data1, data2) {
            let sum = 0;
            let total = data1.length;
            for (let i = 0; i < total; i++) {
                sum += (data1[i] * data2[i]);
            }
            return sum / total;
        }
    </script>

</body>
</html>
